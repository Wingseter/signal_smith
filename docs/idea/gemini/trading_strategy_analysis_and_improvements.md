# Signal Smith: 주식 매매 전략 분석 및 차세대 개선 방향 (V3)

본 문서는 `Signal Smith` 프로젝트 내에 구현된 모든 종목 매수(BUY) 및 매도(SELL) 전략과 그 과정을 분석하고, 해당 로직의 장단점 및 한계점을 진단합니다. 나아가 최신 멀티 에이전트(Multi-Agent) 및 LLM 알고리즘 트레이딩 리서치를 바탕으로 한 개선 방향을 제안합니다.

---

## 1. 현재 주식 매수/매도 전략 및 프로세스 분석

### 1-1. 매수 (BUY) 프로세스
현재 시스템은 퀀트(Quant)와 뉴스(News)라는 두 가지 강력한 트리거를 바탕으로 매수를 결정합니다.

1. **트리거 (Signal Generation)**
   - **퀀트 스캔 (`signal_tasks.py - scan_signals`)**: 시가총액 상위 500개 종목을 대상으로 5분/15분/일봉 지표를 스캔합니다. 복합 점수(Composite Score)가 65점 이상이고 BUY/STRONG_BUY 액션이 떨어지면 AI 회의를 소집합니다.
   - **뉴스 분석 (`news/trader.py`)**: 실시간 뉴스를 파싱하여 호재 수위 점수가 7점 이상일 경우 AI 회의를 소집합니다.

2. **AI Council 합의 과정 (`orchestrator.py - start_meeting`)**
   - **Round 1 (초기 분석)**: 
     - 퀀트 분석가(GPT)는 키움 실시간 차트를, 펀더멘털 분석가(Claude)는 DART 재무제표를 바탕으로 할당 비중(%)과 점수를 독립적으로 제시합니다.
   - **Round 2 (상호 검토)**: 
     - 상대방의 분석 결과를 읽고 자신의 의견을 방어하거나 수정합니다.
   - **Round 3 (최종 합의)**: 
     - 펀더멘털 분석가(Claude)가 양측 의견을 종합하여 최종 투자 비중(%)과 보유 기간(기본 7일)을 확정합니다.

3. **3중 게이트 검증 및 체결 (`orchestrator.py - Gate A, B, C`)**
   - **Gate A (최소 포지션)**: 계산된 매수 금액이 총자산의 8% 미만이면 수수료 낭비 방지를 위해 즉시 매수를 차단(HOLD)합니다.
   - **Gate B (현금 버퍼)**: 매수 후 남은 현금이 총자산의 15% 미만이면 차단합니다.
   - **Gate C (최대 종목 수)**: 자산 규모별 최대 종목 수(예: 500만원 기준 5개)를 초과하면 차단합니다.
   - 조건을 모두 만족하고 신뢰도(Confidence) 점수가 0.6 이상이면 키움 API에 시장가(MARKET) 매수 주문을 넣습니다.

### 1-2. 매도 (SELL) 프로세스
매도는 수익 실현, 리스크 관리, 그리고 포트폴리오 리밸런싱의 세 축으로 이루어집니다.

1. **상시 가격 모니터링 (`signal_tasks.py - monitor_signals`)**
   - AI 회의에서 정해진 **목표가(Target Price)** 에 도달하거나, **손절가(Stop Loss)** 로 떨어지면 즉시 전략 매도(SELL)를 트리거합니다.

2. **포트폴리오 스코어링 (`portfolio_analyzer.py`)**
   - 보유 종목을 주기적으로 분석하여 0~10점의 **매도 점수(Sell Score)** 를 계산합니다.
   - **위험 감지 요소**: 손절선 도달, 익절 목표 도달, 트레일링 스탑(고점 대비 30% 하락), 장기 보유(90일 초과), 비중 과다(30% 초과).
   - **기술적 지표 악화**: RSI 데드크로스, MACD 0선 아래 하향 이탈, 볼린저밴드 하단 돌파, 20일/60일 마이너스 크로스 등.
   - *점수 8점 이상시 SELL(전량 매도), 5점 이상시 PARTIAL_SELL(부분 익절)*.

3. **결함 있는 종목 교체 (Swap)**
   - 현금이 없고 최대 종목 수가 꽉 찼을 때, 보유 종목 중 가장 AI 점수가 낮고 손실 중인 종목을 찾아 신규의 강력한 BUY 시그널 종목과 스왑(Swap)합니다.

---

## 2. 기존 아키텍처의 장단점 및 문제점

### 장점 (Strengths)
1. **환각(Hallucination) 방지 구조**: 단일 LLM에 의존하지 않고 GPT(수치/차트 논리)와 Claude(문맥/재무 추론)를 대결(Debate)시키는 구조는 매우 우수합니다. LLM의 대표적인 맹점인 '지나친 확신'을 서로가 견제합니다.
2. **견고한 룰 기반 리스크 관리**: AI의 판단이 아무리 낙관적이더라도 시스템 레벨에서 3중 게이트(현금 비중, 최소 포지션, 최대 종목 수)로 블로킹 코드를 짠 것은 프로덕션 레벨에서 계좌 파산을 막는 훌륭한 안전장치입니다.

### 단점 및 문제점 (Weaknesses & Issues)
1. **타임아웃과 API 종속성 문제 (Blind Spot)**
   - `orchestrator.py`를 보면 3번의 왕복 AI 호출에 각각 `asyncio.wait_for(timeout=60.0)`이 설정되어 있습니다. 
   - 퀀트 스캐너가 대거 BUY 시그널을 던지면 트래픽 몰림으로 타임아웃이 나고, 시스템은 **단순 산술 평균(fallback)**을 내리게 됩니다. LLM의 장점이 무효화되는 지점입니다.
2. **마이크로스트럭처(Microstructure) 무시 현상**
   - 모든 결정을 **"시장가(MARKET)"** 로 던집니다. 유동성이 부족한 코스닥 종목의 경우, 단일 AI 액션으로 인해 호가창(Orderbook)이 밀려(Slippage) 2~3% 손해를 보고 시작할 수 있습니다.
3. **투자 비중의 경직성**
   - 현재는 AI가 던진 % (예: 20%)를 그냥 믿거나, 아니면 8% 최소 게이트에 걸리느냐 마느냐의 이분법적 수용만 존재합니다.

---

## 3. 리서치 기반 차세대 개선 방향 (Multi-Agent & Sizing Trends 2025-2026)

Tavily MCP 리서치를 통해 조사한 **2025~2026년도 LLM + Multi-Agent 트레이딩의 최신 트렌드**를 바탕으로 한 심화 개선안입니다.

### 3-1. Consensus Mechanism의 고도화: 'Devil's Advocate' 에이전트 추가
*   **트렌드**: 최신 논문들에 따르면 단순히 두 에이전트가 "토론"하는 것을 넘어, 철저히 **반대만 하는 "Devil's Advocate (악마의 대변인)" 에이전트**를 두는 것이 확증 편향(Confirmation Bias)을 줄이는 데 가장 효과적입니다.
*   **개선안**: 
    - AI Council 구성원에 `Risk_Manager_Agent` (예: Gemini Pro 1.5)를 추가합니다. 
    - 해당 에이전트는 GPT와 Claude가 매수에 동의했을 때, 그 종목의 과거 폭락 사유, 공매도 잔고, 섹터 불황 기사만을 RAG로 가져와서 무조건 공격(Rebuttal)하게 만듭니다. 이 공격을 방어해냈을 때만 최종 승인(Approved)합니다.

### 3-2. 동적 포지션 사이징: 변동성(ATR) 기반 LLM-RL 하이브리드
*   **트렌드**: LLM은 "방향성(Up/Down)"과 "이유(Why)"를 맞추는 데 탁월하지만, "얼마나(How much)" 살지에 대한 수치 계산은 형편없습니다. 이 부분은 정통 퀀트 공식이나 강화학습(RL)에 맡기는 추세입니다.
*   **개선안**:
    - AI Council은 "투자 확신도(Confidence 0~1)"만을 출력하도록 역할을 제한합니다.
    - 실제 매수 수량은 시스템이 `ATR(Average True Range, 최근 14일 변동성)`을 계산하여 결정합니다.
    - *공식 예시:* `Risk_Per_Trade = 전체 자산의 2%`. `주식당 리스크 = 매수가 - 손절가 (ATR의 2배)`. `매수 수량 = Risk_Per_Trade / 주식당 리스크 * AI 확신도`.
    - 변동성이 큰 주식은 자동으로 소량 매수되고, 변동성이 적고 안전한 우량주는 대량 매수되어 포트폴리오의 리스크 동등성(Risk Parity)이 맞춰집니다.

### 3-3. Execution Agent (실행 에이전트) 도입을 통한 슬리피지 최소화
*   **트렌드**: 매매를 결정하는 '알파(Alpha) 에이전트'와 실제로 시장에 주문을 넣는 '실행(Execution) 에이전트'의 분리가 표준화되고 있습니다.
*   **개선안**:
    - 매수 결정 시 `OrderType.MARKET`으로 API를 직행하지 않고, `Execution_Agent` 큐에 넣습니다.
    - Execution Agent는 현재 호가창(Ask/Bid)의 잔량을 분석하여, 거래량이 적으면 VWAP(거래량 가중 평균 가격) 알고리즘처럼 10분에 걸쳐 5번 쪼개서 분할 지정가 매수를 실행합니다.
    - 이를 통해 슬리피지 비용을 대폭 절감하고, 장기 수익률을 1~2% 이상 끌어올릴 수 있습니다.

---

## 💡 요약: Signal Smith V3를 위한 Next Step

1.  **AI 체급 구조조정**: LLM에게 비중(%) 계산을 억지로 시키지 말고 논리와 방향성, 확신도(Confidence) 추론에만 집중시키세요. 실제 매수 금액은 백엔드의 `ATR 변동성 수식`에 확신도를 가중치로 곱해 산출하도록 `orchestrator.py`를 리팩토링합니다.
2.  **호가창 최적화 분할 매수 모듈**: 시장가(Market) 주문을 지양하고, `trading_service.py` 내부에 호가 스프레드를 읽고 쪼개서 분할 주문(TWAP/VWAP)을 넣는 로직을 구현하세요.
3.  **악마의 대변인 (Risk Agent) 프롬프트 작성**: 펀더멘털 분석가를 무조건 비판하는 프롬프트를 작성하여 회의 파이프라인(Round 2)에 강제 삽입해 보세요. 승률이 드라마틱하게 올라갑니다.
