# Signal Smith 개선 플랜 V1

> 기반: Day1 실전 결과 분석 + Codex/Gemini AI 아이디어 검토
> 작성일: 2026-03-01

---

## 핵심 진단

Day1의 문제는 **"종목 선정 정확도"가 아니라 "포트폴리오 운영 규율"의 부재**다. (Codex 인용)

| 문제 | 원인 | 영향 |
|---|---|---|
| 소액 포지션 4개 (비중 5.4%) | 최소 포지션 하한 없음 | 수수료 대비 수익 무의미 |
| 현금 고갈 (예수금 5%) | 현금 보유 비율 규칙 없음 | 기회 대응 불가 |
| 두산 비중 31.2% | 매수 시점에만 25% 체크 | 리스크 집중 |
| 키움 API 429 | 연속 요청에 딜레이 없음 | 시세 조회 실패 |
| Gemini 분석 실패 | CLIProxiAPI rate limit | 분석 누락 상태에서 매매 발생 |

---

## Phase 1: 즉시 적용 (1주차)

### 1.1 체결 전 3중 게이트 [출처: Codex P0]

매수 시그널 생성 시 아래 3가지 조건을 모두 통과해야 체결 진행.

**게이트 A — 최소 포지션 금액**
```
규칙: suggested_amount >= 총자산 × 8%
미달 시: 시그널 폐기 (HOLD 전환)
근거: 500만원 기준 최소 40만원. 이 이하는 수수료 대비 의미 없음
```

**게이트 B — 현금 보유 비율**
```
규칙: 매수 후 예상 현금 비중 >= 15%
미달 시: 매수 차단
근거: 75만원 현금 유지 → 긴급 대응 + 기회 포착 여력
```

**게이트 C — 최대 보유 종목 수**
```
규칙: 현재 보유 종목 수 < 최대치
기준:
  ~500만원: 5종목
  ~1,000만원: 7종목
  ~3,000만원: 10종목
초과 시: 매수 차단 (교체 로직은 Phase 2)
```

**수정 대상 파일:**
- `backend/app/config.py`: 설정값 추가
  - `min_position_pct: float = 8.0`
  - `min_cash_reserve_pct: float = 15.0`
  - `max_positions: int = 5`
- `backend/app/services/council/orchestrator.py`: 3중 게이트 로직 삽입
- `backend/app/services/tasks/signal_tasks.py`: available_amount 계산 시 현금버퍼 차감

### 1.2 키움 API 요청 딜레이 [출처: Codex P0 + Gemini 아이디어5]

```
규칙:
- 종목별 시세 조회 간 0.2초 딜레이 (초당 5회 이내)
- 429 응답 시 exponential backoff + jitter (1초 → 2초 → 4초, 최대 3회)
- Retry-After 헤더 있으면 우선 사용
```

**수정 대상 파일:**
- `backend/app/services/kiwoom/rest_client.py`: `_request()` 메서드에 429 재시도 로직 추가
- `backend/app/services/tasks/__init__.py`: monitor_signals 태스크에 종목 간 asyncio.sleep(0.2)

### 1.3 데이터 품질 게이트 [출처: Codex P2 → 승격]

AI 분석 실패 상태에서 매매하면 안 된다. 즉시 적용.

```
규칙:
- GPT/Claude/Gemini 중 2개 이상 분석 실패 시 → 해당 종목 시그널 폐기
- 1개 실패 시 → 신뢰도 -0.15 강등 후 재평가
- 분석 실패 = "⚠️ 분석 중 오류" 응답 또는 timeout
```

**수정 대상 파일:**
- `backend/app/services/council/orchestrator.py`: 회의 종료 시 분석 성공/실패 카운트 체크

---

## Phase 2: 시스템 안정화 (2주차)

### 2.1 드리프트 리밸런싱 + 부분 익절 [출처: Codex P0 + Gemini 아이디어1 결합]

매수 시점 25% 상한만으로는 사후 비중 초과를 막을 수 없다.
두 AI의 아이디어를 결합한 방식:

```
밴드 운영:
- 비중 > 30%: 초과분 즉시 시장가 매도 (부분 익절) → 현금 복구
- 비중 25~30%: 경고 로깅, 신규 매수 시 해당 종목 추가매수 차단
- 비중 20~25%: 정상 유지
- 비중 < 8%: 의미 없는 포지션으로 판단, 정리 후보 등록

체크 시점: monitor_signals 태스크 (매 분 실행)
```

**Gemini의 "초과분만 매도" + Codex의 "다음 이벤트 시 교정" 하이브리드:**
- 30% 초과는 즉시 부분 매도 (위험 방지)
- 25~30%는 패시브 교정 (거래비용 절감)

### 2.2 교체형 매수 (포트폴리오 스왑) [출처: Codex P1 + Gemini 아이디어3]

보유 종목이 최대치이고 현금이 부족한데, 더 좋은 시그널이 들어올 때:

```
교체 조건 (3가지 모두 충족):
1. 신규 시그널 AI 점수 > 보유 최하위 AI 점수 + 2점
2. 보유 최하위 종목의 현재 수익률 < 0% (손실 중)
3. 교체 비용(수수료+세금+슬리피지 약 0.5%) 감안 후에도 기대 이익 양수

교체 프로세스:
1. 보유 종목 중 "AI 점수 최하위 + 수익률 최하위" 종목 선정
2. 해당 종목 전량 매도
3. 매도 대금으로 신규 종목 매수
```

**Gemini의 "매일 전종목 재점수"는 API 비용 과다 → 주 1회 리뷰로 축소:**
- 매주 월요일 장 전: 보유 전 종목 AI 재평가
- 점수 하위 20% 종목은 "교체 대기" 플래그

### 2.3 신호 강도 기반 계단형 사이징 [출처: Codex P1]

AI 확신도에 따라 투자 비중을 계단형으로 결정:

```
AI Council 합의 점수 → 투자 비중:
- 9~10점 (강력 확신): 20%
- 7~8점 (확신):       15%
- 5~6점 (보통):       10%
- 4점 이하:           매수 패스

보정 규칙:
- 변동성 상위 20% 종목: 한 단계 하향
- 기존 보유 종목과 동일 섹터: 한 단계 하향
```

현재 AI가 자유롭게 %를 제안하는 방식 → 계단형으로 교체하면 소액 포지션 원천 차단.

---

## Phase 3: 고도화 (3~4주차)

### 3.1 매크로 환경 기반 동적 현금 비중 [출처: Gemini 아이디어4]

시장 상황에 따라 현금 비율을 유동적으로 조절:

```
장세 판단 (주 1회, 월요일 장 전):
- 상승장 (Bull):  현금 목표 10%  → 공격적 투자
- 횡보장 (Sideways): 현금 목표 15% → 기본 운영
- 하락장 (Bear):  현금 목표 30%  → 방어적 운영

판단 기준:
- 코스피 5일/20일 이동평균선 배열
- 최근 5일 외국인/기관 순매수 추이
- VIX 한국판 (VKOSPI) 수준

구현: Gemini에게 주 1회 매크로 프롬프트 → 장세 분류 → 시스템 파라미터 업데이트
```

### 3.2 성과 측정 KPI 체계 [출처: Codex P2]

2주 단위로 측정하여 파라미터 튜닝:

```
필수 KPI:
- 평균 포지션 금액 (목표: > 총자산 × 8%)
- 최소 포지션 게이트에 의해 차단된 시그널 수
- 현금 비중 평균/최저 (목표: 평균 > 15%)
- 429 에러 발생률 / 재시도 성공률
- 종목별 AI 점수 vs 실제 수익률 상관관계
- 교체 매매 승률
```

### 3.3 Modified Kelly Criterion [출처: Gemini 아이디어2 → 보류]

충분한 데이터(최소 50건 이상 매매 이력)가 쌓인 후:
- AI 확신도별 실제 승률/손익비를 역산
- Kelly 공식으로 최적 비중 산출
- 현재의 계단형 사이징을 점진적으로 대체

**현 시점에서는 데이터 부족으로 보류. Phase 3 이후 재검토.**

---

## 구현 로드맵

```
Week 1 (Phase 1): 즉시 효과
├── config.py: min_position_pct, min_cash_reserve_pct, max_positions 추가
├── orchestrator.py: 3중 게이트 + 데이터 품질 게이트
├── rest_client.py: 429 backoff + jitter + 요청 간 딜레이
└── 배포 → Day2부터 적용

Week 2 (Phase 2): 안정화
├── orchestrator.py: 계단형 사이징
├── monitor_signals: 드리프트 밴드 체크 + 부분 익절
├── 교체형 매수 로직 설계 + 구현
└── 배포 → Week2부터 적용

Week 3-4 (Phase 3): 고도화
├── 매크로 환경 판단 프롬프트 + 동적 현금 비중
├── KPI 대시보드 + 파라미터 튜닝
└── 데이터 축적 후 Kelly Criterion 검토
```

---

## 아이디어 채택/기각 요약

| 출처 | 아이디어 | 판정 | 적용 시점 | 사유 |
|---|---|---|---|---|
| Codex | 3중 게이트 | ✅ 채택 | Phase 1 | 핵심. 소액포지션+현금고갈 동시 해결 |
| Codex | 429 backoff + jitter | ✅ 채택 | Phase 1 | 표준적 해법, 필수 |
| Codex | 드리프트 밴드 (20~25%) | ✅ 채택 | Phase 2 | 거래비용 절감하며 비중 교정 |
| Codex | 계단형 사이징 | ✅ 채택 | Phase 2 | 소액 포지션 원천 차단 |
| Codex | 교체형 매수 | ✅ 채택 | Phase 2 | 현금 부족 시 유일한 해법 |
| Codex | 데이터 품질 게이트 | ✅ 채택 (승격) | Phase 1 | 분석 실패 상태 매매 차단 필수 |
| Codex | KPI 체계 | ✅ 채택 | Phase 3 | 장기 튜닝에 필수 |
| Gemini | 부분 익절 (초과분 매도) | ✅ 채택 | Phase 2 | Codex 밴드와 결합, 30% 초과 시 즉시 매도 |
| Gemini | Token Bucket | ✅ 채택 | Phase 1 | 키움 API 안정화 |
| Gemini | 매크로 동적 현금 비중 | ✅ 채택 | Phase 3 | 장기적으로 가치 있음 |
| Gemini | Modified Kelly | ⏸ 보류 | 데이터 축적 후 | 현재 매매 이력 부족 |
| Gemini | 매일 전종목 재점수 | ⚠️ 축소 | Phase 2 | API 비용 과다 → 주 1회로 |
| Gemini | Fallback 모델 | ❌ 기각 | - | CLIProxiAPI 전환으로 해소됨 |
